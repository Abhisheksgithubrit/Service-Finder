<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Maps with Directions</title>
    <!-- Load Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDCyzs_FRtMORUoJKpoHOMw4kaYsUVLlzw" async defer></script>
</head>
<body>

    {% for s in shops %}
        <h3>{{ s.shop_name }}</h3>
        <p>Owner: {{ s.owner_name }}</p>
        <p>Latitude: {{ s.latitude }}</p>
        <p>Longitude: {{ s.longitude }}</p>
        
        <!-- Map container for this shop -->
        <div id="map-{{ forloop.counter }}" style="height: 400px; width: 100%;"></div>
        
        <!-- Button to get directions -->
        <button onclick="getDirections({{ s.latitude }}, {{ s.longitude }}, 'map-{{ forloop.counter }}')">Get Directions</button>

        <script>
            var shopLat = parseFloat('{{ s.latitude }}');
            var shopLng = parseFloat('{{ s.longitude }}');

            // Initialize the map with the shop location
            function initMap() {
                var map = new google.maps.Map(document.getElementById('map-{{ forloop.counter }}'), {
                    zoom: 12,
                    center: { lat: shopLat, lng: shopLng }
                });

                // Add a marker for the shop
                new google.maps.Marker({
                    position: { lat: shopLat, lng: shopLng },
                    map: map,
                    title: '{{ s.shop_name }}'
                });
            }

            // Function to get directions when the button is clicked
            function getDirections(shopLat, shopLng, mapElementId) {
                // Check if geolocation is supported
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        var userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        // Initialize the map with the user's location
                        var map = new google.maps.Map(document.getElementById(mapElementId), {
                            zoom: 12,
                            center: userLocation
                        });

                        // Directions service and renderer
                        var directionsService = new google.maps.DirectionsService();
                        var directionsRenderer = new google.maps.DirectionsRenderer();
                        directionsRenderer.setMap(map);

                        // Request directions from user's location to shop's location
                        var request = {
                            origin: userLocation,
                            destination: { lat: shopLat, lng: shopLng },
                            travelMode: 'DRIVING'  // Can be 'WALKING', 'BICYCLING', 'TRANSIT'
                        };

                        // Calculate and display the route
                        directionsService.route(request, function(result, status) {
                            if (status === 'OK') {
                                directionsRenderer.setDirections(result);
                            } else {
                                alert('Directions request failed due to ' + status);
                            }
                        });
                    }, function() {
                        alert("Geolocation failed or is not supported by your browser.");
                    });
                } else {
                    alert("Geolocation is not supported by this browser.");
                }
            }

            // Initialize the map when the page loads
            window.addEventListener('load', initMap);
        </script>
    {% endfor %}

</body>
</html>
